<!DOCTYPE html>
{% load static %}
<html lang="en">
<head>
    <meta name="csrf-token" content="{{ csrf_token }}">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="{% static 'bootstrap/css/bootstrap.min.css'%}" rel="stylesheet" >
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet">
    <script src="{% static 'bootstrap/js/bootstrap.min.js'%}"></script>
    <link rel="stylesheet" href="{% static 'css/style.css'%}">
    <title>ДПС.НЕТ</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://api-maps.yandex.ru/2.1/?apikey=84c2e56f-c053-436b-b1e6-9e806eb1383b&lang=ru_RU" type="text/javascript">
    </script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script></script>
</head>
<body>
    <button id="addMarkerBtn">Добавить метку</button>
    <div id="map" style="width: 600px; height: 400px;"></div>
    <script>
        ymaps.ready(init);
        let myMap;
        let clickCoords;
    
        function init(){
            myMap = new ymaps.Map("map", {
                center: [55.76, 37.64], // Москва
                zoom: 17
            });
    
            document.getElementById('addMarkerBtn').addEventListener('click', () => {
                myMap.events.add('click', onMapClick);
            });
            navigator.geolocation.getCurrentPosition(function(position) {
        var userCoords = [position.coords.latitude, position.coords.longitude];
        myMap.setCenter(userCoords, 12); // Центрирование карты на местоположении пользователя и установка масштаба

        // Создание круга вокруг текущего местоположения пользователя
        var userLocationCircle = new ymaps.Circle([
            userCoords, // Координаты центра круга
            100 // Радиус круга в метрах
        ], {
            balloonContent: "Вы здесь"
        }, {
            fillColor: "#1E90FF88", // Цвет заливки: синий с прозрачностью
            strokeColor: "#1E90FF", // Цвет границы: синий
            strokeOpacity: 0.8, // Прозрачность границы
            strokeWidth: 2 // Ширина границы
        });

        myMap.geoObjects.add(userLocationCircle);

        }, function(error) {
            console.error("Ошибка при получении местоположения: ", error);
        });
            updateMarkers();
            setInterval(updateMarkers, 30000); // Обновление каждую минуту
        }
    
        function onMapClick(e) {
            clickCoords = e.get('coords');
            addMarker(clickCoords[0], clickCoords[1]);
            myMap.events.remove('click', onMapClick);
        }
    
        function addMarker(lat, lon) {
            fetch(`/add_marker/?lat=${lat}&lon=${lon}`)
                .then(() => {
                    myMap.geoObjects.add(new ymaps.Placemark([lat, lon]));
                    updateMarkers();
                });
        }
    
        function updateMarkers() {
          
            fetch('/get_markers/')
                .then(response => response.json())
                .then(markers => {
                    myMap.geoObjects.removeAll();
                    markers.forEach(marker => {
                        myMap.geoObjects.add(new ymaps.Placemark([marker.lat, marker.lon]));
                    });
                });
           
        }
    </script>
</body>
</html>

