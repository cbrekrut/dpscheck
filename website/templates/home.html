{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="csrf-token" content="{{ csrf_token }}">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="{% static 'bootstrap/css/bootstrap.min.css'%}" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet">
    <script src="{% static 'bootstrap/js/bootstrap.min.js'%}"></script>
    <link rel="stylesheet" href="{% static 'css/style.css'%}">
    <title>ДПС.НЕТ</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://api-maps.yandex.ru/2.1/?apikey=84c2e56f-c053-436b-b1e6-9e806eb1383b&lang=ru_RU" type="text/javascript"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
    </script>
    <style>
        html, body, #map {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
        }
        body {
            display: flex;
            flex-direction: column;
        }
        main {
            flex: 1;
            display: flex;
        }
        .map {
            flex: 1;
        }
         /* Стили для загрузочного экрана */
         #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: black;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .loading-bar {
            width: 80%;
            height: 20px;
            background-color: white;
            border-radius: 10px;
            margin-top: 20px;
            overflow: hidden;
        }
        .loading-bar div {
            height: 100%;
            width: 0;
            background-color: #1E90FF;
            border-radius: 10px;
            animation: loading 3s infinite;
        }
        @keyframes loading {
            0% { width: 0; }
            50% { width: 100%; }
            100% { width: 0; }
        }
    </style>
</head>
<body>
    <!-- Загрузочный экран -->
    <div id="loading-screen">
        <h1>ДПС.НЕТ</h1>
        <div class="loading-bar"><div></div></div>
    </div>
    <header style="z-index: 1; position: fixed; width: 100%;">
        <div class="container my-navbar mt-2 py-2 mx-2" style="width: auto;">
            <div class="row justify-content-between">
                <div class="col-4 d-flex align-items-center justify-content-center ps-0">
                    <a href="#" class="location my-anchor">
                        <div>
                            <img src="{% static 'media/icon/mapmarker.png' %}" alt="" height="28px" width="27px">
                            <span class="fw-bold">Тверь</span>
                        </div>
                    </a>
                </div>
                <div class="col-3">
                    <div class="online text-center d-flex align-items-center justify-content-center">
                        <div class="pulsating-circle me-1"></div>
                        <span style="color:white;" class="fs-5 fw-bold">1054</span>
                    </div>
                </div>
                <div class="col-3 text-center">
                    <div class="dps-quantity text-center d-flex align-items-center justify-content-center" style="height: 100%; width:100%;">
                        <img src="{% static 'media/icon/police.png' %}" alt="" height="28px" width="27px" class="me-1">
                        <span id='dps-quant' style="color:white;" class="fs-5 fw-bold">25</span>
                    </div>
                </div>
                <div class="col-2 text-center d-flex align-items-center justify-content-center">
                    <a href="" class="profile">
                        <img src="{% static 'media/icon/profile.png' %}" alt="" height="36px" width="36px">
                    </a>
                </div>
            </div>
        </div>
    </header>
    <main>
        <div id='map' class="map"></div>
        <i id="custom-marker-icon" class="fa-solid fa-handcuffs" style="display: none;"></i>
    </main>
    <footer style="position: absolute; bottom: 2%; left: 25%; z-index: 1; width: 50vw; border-radius: 16px;">
        <div class="container py-2" style="background-color: black; border-radius: 16px; width: 80%;">
            <div class="row justify-content-center">
                <div class="col-6 text-center" id="addMarkerBtn">
                    <img src="{% static 'media/icon/map.png' %}" alt="" style="width: 100%; height: 100%; object-fit: contain;">
                </div>
            </div>
        </div>
    </footer>
    <script>
        ymaps.ready(init);
        let myMap;
        let clickCoords;

        function init() {
            myMap = new ymaps.Map("map", {
                center: [55.76, 37.64], // Москва
                zoom: 17
            });

            document.getElementById('addMarkerBtn').addEventListener('click', () => {
                myMap.events.add('click', onMapClick);
            });

            navigator.geolocation.getCurrentPosition(function(position) {
                var userCoords = [position.coords.latitude, position.coords.longitude];
                myMap.setCenter(userCoords, 12); // Центрирование карты на местоположении пользователя и установка масштаба

                // Создание круга вокруг текущего местоположения пользователя
                var userLocationCircle = new ymaps.Circle([
                    userCoords, // Координаты центра круга
                    100 // Радиус круга в метрах
                ], {
                    balloonContent: "Вы здесь"
                }, {
                    fillColor: "#1E90FF88", // Цвет заливки: синий с прозрачностью
                    strokeColor: "#1E90FF", // Цвет границы: синий
                    strokeOpacity: 0.8, // Прозрачность границы
                    strokeWidth: 2 // Ширина границы
                });

                myMap.geoObjects.add(userLocationCircle);

            }, function(error) {
                console.error("Ошибка при получении местоположения: ", error);
            });

            updateMarkers();
            setInterval(updateMarkers, 60000); // Обновление каждые 30 секунд
            // Скрытие загрузочного экрана после загрузки карты
            document.getElementById('loading-screen').style.display = 'none';
        }

        function onMapClick(e) {
            clickCoords = e.get('coords');
            addMarker(clickCoords[0], clickCoords[1]);
            myMap.events.remove('click', onMapClick);
        }

        function addMarker(lat, lon) {
    fetch(`/add_marker/?lat=${lat}&lon=${lon}`)
        .then(() => {
            var svgIcon = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="#ff0000" d="M280 24c0-13.3-10.7-24-24-24s-24 10.7-24 24l0 80c0 13.3 10.7 24 24 24s24-10.7 24-24l0-80zM185.8 224l140.3 0c6.8 0 12.8 4.3 15.1 10.6L360.3 288l-208.6 0 19.1-53.4c2.3-6.4 8.3-10.6 15.1-10.6zm-75.3-10.9L82.2 292.4C62.1 300.9 48 320.8 48 344l0 40 0 64 0 32c0 17.7 14.3 32 32 32l16 0c17.7 0 32-14.3 32-32l0-32 256 0 0 32c0 17.7 14.3 32 32 32l16 0c17.7 0 32-14.3 32-32l0-32 0-64 0-40c0-23.2-14.1-43.1-34.2-51.6l-28.3-79.3C390.1 181.3 360 160 326.2 160l-140.3 0c-33.8 0-64 21.3-75.3 53.1zM128 344a24 24 0 1 1 0 48 24 24 0 1 1 0-48zm232 24a24 24 0 1 1 48 0 24 24 0 1 1 -48 0zM39 39c-9.4 9.4-9.4 24.6 0 33.9l48 48c9.4 9.4 24.6 9.4 33.9 0s9.4-24.6 0-33.9L73 39c-9.4-9.4-24.6-9.4-33.9 0zm400 0L391 87c-9.4 9.4-9.4 24.6 0 33.9s24.6 9.4 33.9 0l48-48c9.4-9.4 9.4-24.6 0-33.9s-24.6-9.4-33.9 0z"/></svg>`;
            myMap.geoObjects.add(new ymaps.Placemark([lat, lon], {}, {
                iconLayout: 'default#imageWithContent',
                iconImageHref: 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(svgIcon),
                iconImageSize: [32, 32],
                iconImageOffset: [-16, -16]
            }));
            updateMarkers();
        });
}

function updateMarkers() {
    fetch('/get_markers/')
        .then(response => response.json())
        .then(data => {
            myMap.geoObjects.removeAll(); // Удаляем все существующие метки

            var svgIcon = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="#ff0000" d="M280 24c0-13.3-10.7-24-24-24s-24 10.7-24 24l0 80c0 13.3 10.7 24 24 24s24-10.7 24-24l0-80zM185.8 224l140.3 0c6.8 0 12.8 4.3 15.1 10.6L360.3 288l-208.6 0 19.1-53.4c2.3-6.4 8.3-10.6 15.1-10.6zm-75.3-10.9L82.2 292.4C62.1 300.9 48 320.8 48 344l0 40 0 64 0 32c0 17.7 14.3 32 32 32l16 0c17.7 0 32-14.3 32-32l0-32 256 0 0 32c0 17.7 14.3 32 32 32l16 0c17.7 0 32-14.3 32-32l0-32 0-64 0-40c0-23.2-14.1-43.1-34.2-51.6l-28.3-79.3C390.1 181.3 360 160 326.2 160l-140.3 0c-33.8 0-64 21.3-75.3 53.1zM128 344a24 24 0 1 1 0 48 24 24 0 1 1 0-48zm232 24a24 24 0 1 1 48 0 24 24 0 1 1 -48 0zM39 39c-9.4 9.4-9.4 24.6 0 33.9l48 48c9.4 9.4 24.6 9.4 33.9 0s9.4-24.6 0-33.9L73 39c-9.4-9.4-24.6-9.4-33.9 0zm400 0L391 87c-9.4 9.4-9.4 24.6 0 33.9s24.6 9.4 33.9 0l48-48c9.4-9.4 9.4-24.6 0-33.9s-24.6-9.4-33.9 0z"/></svg>`;

            data.markers.forEach(marker => {
                myMap.geoObjects.add(new ymaps.Placemark([marker.lat, marker.lon], {}, {
                    iconLayout: 'default#imageWithContent',
                    iconImageHref: 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(svgIcon),
                    iconImageSize: [32, 32],
                    iconImageOffset: [-16, -16]
                }));
            });

            document.getElementById('dps-quant').textContent = data.active_markers_count; // Обновляем количество активных меток
        });
}

    </script>
</body>
</html>
